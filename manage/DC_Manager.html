<!doctype html>
<html lang="en">

    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>DC Data Manager</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="css/manage_style.css" />
    </head>

    <body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
        <div class="absolute top-4 left-4 flex gap-x-3">
            <button id="back-to-home-btn"
                class="inline-flex items-center bg-white text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-100 transition border border-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back
            </button>
            <button id="logout-button"
                class="hidden inline-flex items-center bg-white text-red-600 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-100 transition border border-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                Logout
            </button>
        </div>

        <div id="login-view" class="flex items-center justify-center min-h-screen">
            <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
                <header class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">DC Data Manager</h1>
                    <p class="text-gray-500 mt-1">Please log in to continue</p>
                </header>
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block mb-1 text-sm font-medium text-gray-700">Email</label>
                        <input id="login-email" type="email" placeholder="admin@example.com" class="form-input" />
                    </div>
                    <div>
                        <label for="login-password"
                            class="block mb-1 text-sm font-medium text-gray-700">Password</label>
                        <input id="login-password" type="password" class="form-input" />
                    </div>
                    <p id="login-error" class="text-red-500 text-sm hidden"></p>
                    <button id="login-button"
                        class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition">
                        Login
                    </button>
                    <button id="forgot-password-btn"
                        class="text-sm text-blue-600 hover:underline text-center w-full mt-2">
                        Forgot Password?
                    </button>
                </div>
            </div>
        </div>

        <div id="main-content-view" class="hidden">
            <div class="max-w-2xl w-full bg-white p-8 rounded-xl shadow-lg mt-16">
                <header class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">DC Data Manager</h1>
                    <p class="text-gray-500 mt-1">Upload new data or edit existing entries.</p>
                </header>

                <div class="flex border-b-2 border-gray-200 mb-6">
                    <button id="view-uploader-btn" class="main-tab-btn active">Upload Data</button>
                    <button id="view-editor-btn" class="main-tab-btn">Edit Data</button>
                </div>

                <div id="uploader-view">
                    <div class="flex space-x-2 bg-gray-100 p-1 rounded-lg mb-6">
                        <button id="toggle-file-btn" class="toggle-btn active">Upload File</button>
                        <button id="toggle-manual-btn" class="toggle-btn inactive">Input Manually</button>
                    </div>

                    <div>
                        <div id="file-upload-container">
                            <div class="bg-gray-50 p-6 rounded-lg space-y-6">
                                <div class="border-b pb-6 border-gray-200">
                                    <label for="dc-file-input" class="block mb-2 text-sm font-medium text-gray-700">1.
                                        Upload DC File (.csv)</label>
                                    <input id="dc-file-input" type="file" accept=".csv,.txt"
                                        class="file-input-custom mb-3" />
                                    <button id="dc-file-upload-button"
                                        class="w-full bg-emerald-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-emerald-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                                        Upload DC File
                                    </button>
                                </div>

                                <div>
                                    <label for="durations-file-input"
                                        class="block mb-2 text-sm font-medium text-gray-700">2. Upload Durations File
                                        (.csv)</label>
                                    <input id="durations-file-input" type="file" accept=".csv,.txt"
                                        class="file-input-custom mb-3" />
                                    <button id="durations-file-upload-button"
                                        class="w-full bg-emerald-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-emerald-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                                        Upload Durations File
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 text-center">
                                    Note: Files should be Comma-Separated (CSV)
                                </p>
                            </div>
                        </div>
                        <div id="manual-input-container" class="hidden">
                            <div id="manual-step-1">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Step 1: Enter DC Details</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="dc-name" class="block mb-1 text-sm font-medium text-gray-700">DC
                                            Name</label>
                                        <input id="dc-name" type="text" placeholder="e.g., DC_SURABAYA"
                                            class="form-input" />
                                    </div>
                                    <div>
                                        <label for="dc-loc" class="block mb-1 text-sm font-medium text-gray-700">Loc
                                            ID</label>
                                        <input id="dc-loc" type="text" placeholder="e.g., 1234" class="form-input" />
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="dc-lat"
                                                class="block mb-1 text-sm font-medium text-gray-700">Latitude</label>
                                            <input id="dc-lat" type="number" step="any" placeholder="e.g., -7.2575"
                                                class="form-input" />
                                        </div>
                                        <div>
                                            <label for="dc-lon"
                                                class="block mb-1 text-sm font-medium text-gray-700">Longitude</label>
                                            <input id="dc-lon" type="number" step="any" placeholder="e.g., 112.7521"
                                                class="form-input" />
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="dc-fpallet"
                                                class="block mb-1 text-sm font-medium text-gray-700">Food Pallet</label>
                                            <input id="dc-fpallet" type="number" placeholder="e.g., 100"
                                                class="form-input" />
                                        </div>
                                        <div>
                                            <label for="dc-fpalletcap"
                                                class="block mb-1 text-sm font-medium text-gray-700">Food Pallet
                                                Capacity</label>
                                            <input id="dc-fpalletcap" type="number" placeholder="e.g., 200"
                                                class="form-input" />
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="dc-nfpallet"
                                                class="block mb-1 text-sm font-medium text-gray-700">Non-Food
                                                Pallet</label>
                                            <input id="dc-nfpallet" type="number" placeholder="e.g., 50"
                                                class="form-input" />
                                        </div>
                                        <div>
                                            <label for="dc-nfpalletcap"
                                                class="block mb-1 text-sm font-medium text-gray-700">Non-Food Pallet
                                                Capacity</label>
                                            <input id="dc-nfpalletcap" type="number" placeholder="e.g., 100"
                                                class="form-input" />
                                        </div>
                                    </div>
                                </div>
                                <button id="manual-next-btn"
                                    class="mt-6 w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition">
                                    Next: Add Durations
                                </button>
                            </div>

                            <div id="manual-step-2" class="hidden">
                                <h3 class="text-lg font-semibold text-gray-700 mb-1">Step 2: Add Durations</h3>
                                <p class="text-sm text-gray-600 mb-4">
                                    Enter durations *from* <strong id="origin-dc-name" class="text-blue-600"></strong>.
                                    (Optional: you can skip this to only add the DC)
                                </p>

                                <div id="durations-list-container" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                                </div>

                                <button id="add-duration-btn"
                                    class="mt-4 w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition border border-gray-300">
                                    + Add Another Duration
                                </button>

                                <div class="flex space-x-4 mt-6">
                                    <button id="manual-back-btn"
                                        class="w-1/3 bg-gray-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-600 transition">
                                        Back
                                    </button>
                                    <button id="manual-upload-button"
                                        class="w-2/3 bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-emerald-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                                        Upload Manual Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <div id="status-container" class="space-y-3 text-sm">
                            <p id="status-auth">
                                <span class="status-dot"></span>
                                <span class="font-medium"> Authentication:</span> Waiting...
                            </p>
                            <p id="status-file">
                                <span class="status-dot"></span>
                                <span class="font-medium">Data Status:</span> Pending
                            </p>
                            <p id="status-dcs">
                                <span class="status-dot"></span>
                                <span class="font-medium">DCs Collection:</span> Pending
                            </p>
                            <p id="status-durations">
                                <span class="status-dot"></span>
                                <span class="font-medium">Durations Collection:</span> Pending
                            </p>
                            <p id="status-final" class="font-bold text-lg text-center pt-4"></p>
                        </div>

                        <button id="upload-another-button"
                            class="hidden w-full mt-4 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition">
                            Upload Another
                        </button>
                    </div>
                </div>

                <div id="editor-view" class="hidden">
                    <div id="dc-list-view">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">Manage DCs</h3>
                            <div class="flex space-x-2 items-center">
                                <input id="dc-search-input" type="text" placeholder="Search by name or loc"
                                    class="form-input w-64" />
                            </div>
                        </div>
                        <div id="dc-list-container" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                            <p id="dc-list-loading" class="text-gray-500">Loading DC list...</p>
                        </div>
                    </div>

                    <div id="duration-list-view" class="hidden">
                        <button id="back-to-dcs-btn"
                            class="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-800 mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7" />
                            </svg>
                            Back to DC List
                        </button>
                        <h3 id="duration-view-title" class="text-xl font-semibold text-gray-800 mb-4">
                            Manage Durations
                        </h3>
                        <div id="durations-list" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                            <p id="duration-list-loading" class="text-gray-500">Loading durations...</p>
                        </div>
                        <button id="add-new-duration-btn"
                            class="mt-4 w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition border border-green-700">
                            + Add New Duration
                        </button>
                    </div>

                    <div id="avoided-list-view" class="hidden">
                        <button id="back-to-dcs-from-avoided-btn"
                            class="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-800 mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7" />
                            </svg>
                            Back to DC List
                        </button>
                        <h3 id="avoided-view-title" class="text-xl font-semibold text-gray-800 mb-4">
                            Manage Avoided Destinations
                        </h3>
                        <div id="avoided-list" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                            <p id="avoided-list-loading" class="text-gray-500">Loading avoided destinations...</p>
                        </div>
                        <button id="add-new-avoided-btn"
                            class="mt-4 w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition border border-red-700">
                            + Add New Avoided Destination
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="edit-dc-modal" class="modal-backdrop hidden">
            <div class="modal-content">
                <h3 class="text-xl font-semibold mb-4">Edit DC Details</h3>
                <div class="space-y-4">
                    <div>
                        <label for="modal-dc-name" class="block mb-1 text-sm font-medium text-gray-700">DC Name
                            (Read-only)</label>
                        <input id="modal-dc-name" type="text" class="form-input" readonly />
                    </div>
                    <div>
                        <label for="modal-dc-loc" class="block mb-1 text-sm font-medium text-gray-700">Loc ID</label>
                        <input id="modal-dc-loc" type="text" class="form-input" />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="modal-dc-lat"
                                class="block mb-1 text-sm font-medium text-gray-700">Latitude</label>
                            <input id="modal-dc-lat" type="number" step="any" class="form-input" />
                        </div>
                        <div>
                            <label for="modal-dc-lon"
                                class="block mb-1 text-sm font-medium text-gray-700">Longitude</label>
                            <input id="modal-dc-lon" type="number" step="any" class="form-input" />
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="modal-dc-fpallet" class="block mb-1 text-sm font-medium text-gray-700">Food
                                Pallet</label>
                            <input id="modal-dc-fpallet" type="number" class="form-input" />
                        </div>
                        <div>
                            <label for="modal-dc-fpalletcap" class="block mb-1 text-sm font-medium text-gray-700">Food
                                Pallet Capacity</label>
                            <input id="modal-dc-fpalletcap" type="number" class="form-input" />
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="modal-dc-nfpallet" class="block mb-1 text-sm font-medium text-gray-700">Non-Food
                                Pallet</label>
                            <input id="modal-dc-nfpallet" type="number" class="form-input" />
                        </div>
                        <div>
                            <label for="modal-dc-nfpalletcap"
                                class="block mb-1 text-sm font-medium text-gray-700">Non-Food Pallet Capacity</label>
                            <input id="modal-dc-nfpalletcap" type="number" class="form-input" />
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="modal-dc-cancel"
                        class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300">
                        Cancel
                    </button>
                    <button id="modal-dc-save"
                        class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <div id="edit-duration-modal" class="modal-backdrop hidden">
            <div class="modal-content">
                <h3 id="modal-duration-title" class="text-xl font-semibold mb-4">Edit Duration</h3>
                <p id="modal-duration-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <div class="space-y-4">
                    <div>
                        <label for="modal-duration-dest"
                            class="block mb-1 text-sm font-medium text-gray-700">Destination DC</label>
                        <select id="modal-duration-dest" class="form-input"></select>
                    </div>
                    <div>
                        <label for="modal-duration-km" class="block mb-1 text-sm font-medium text-gray-700">Distance
                            (KM)</label>
                        <input id="modal-duration-km" type="number" placeholder="e.g., 120" class="form-input" />
                    </div>
                    <div>
                        <label for="modal-duration-text" class="block mb-1 text-sm font-medium text-gray-700">Duration
                            Text</label>
                        <input id="modal-duration-text" type="text" placeholder="e.g., 2 hours 15 minutes"
                            class="form-input" />
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="modal-duration-cancel"
                        class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300">
                        Cancel
                    </button>
                    <button id="modal-duration-save"
                        class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <div id="add-avoided-modal" class="modal-backdrop hidden">
            <div class="modal-content">
                <h3 id="modal-avoided-title" class="text-xl font-semibold mb-4">Add Avoided Destination</h3>
                <p id="modal-avoided-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <div class="space-y-4">
                    <div>
                        <label for="modal-avoided-target" class="block mb-1 text-sm font-medium text-gray-700">Target DC
                            to Avoid</label>
                        <select id="modal-avoided-target" class="form-input"></select>
                    </div>
                    <div>
                        <label for="modal-avoided-reason"
                            class="block mb-1 text-sm font-medium text-gray-700">Reason</label>
                        <input id="modal-avoided-reason" type="text" placeholder="e.g., Road construction"
                            class="form-input" />
                        <p class="text-xs text-gray-500 mt-1">Note: This will also add an avoidance rule for the target
                            DC back to this DC.</p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="modal-avoided-cancel"
                        class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300">
                        Cancel
                    </button>
                    <button id="modal-avoided-save"
                        class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <div id="delete-confirm-modal" class="modal-backdrop hidden">
            <div class="modal-content">
                <h3 class="text-xl font-semibold mb-2">Are you sure?</h3>
                <p id="delete-confirm-text" class="text-gray-600 mb-6">
                    Do you really want to delete this item? This action cannot be undone.
                </p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-delete-cancel"
                        class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300">
                        Cancel
                    </button>
                    <button id="modal-delete-confirm"
                        class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700">
                        Delete
                    </button>
                </div>
            </div>
        </div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

            import {
                getAuth,
                signInWithEmailAndPassword,
                onAuthStateChanged,
                signOut,
                sendPasswordResetEmail,
                setPersistence,
                inMemoryPersistence
            } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

            import {
                getFirestore,
                doc,
                writeBatch,
                collection,
                getDocs,
                setLogLevel,
                onSnapshot,
                updateDoc,
                deleteDoc,
                getDoc,
                setDoc,
                arrayUnion, // NEW
                arrayRemove // NEW
            } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

            const firebaseConfig = {
                apiKey: "AIzaSyDcvUFQtYvwyYGcT4B1Ff4A5s5uXa6u95s",
                authDomain: "dc-searcher-app.firebaseapp.com",
                projectId: "dc-searcher-app",
                storageBucket: "dc-searcher-app.firebasestorage.app",
                messagingSenderId: "739161146197",
                appId: "1:739161146197:web:f4f2fed0e724217d2c25dc"
            };

            let db;
            let auth; // NEW: Auth service
            let allDcs = [];
            let currentEditingDcName = null;
            let currentDurations = {};
            let currentAvoided = []; // NEW
            let currentDeleteContext = {};

            // --- Query Selectors ---
            const viewUploaderBtn = document.getElementById("view-uploader-btn");
            const viewEditorBtn = document.getElementById("view-editor-btn");
            const uploaderView = document.getElementById("uploader-view");
            const editorView = document.getElementById("editor-view");
            const toggleFileBtn = document.getElementById("toggle-file-btn");
            const toggleManualBtn = document.getElementById("toggle-manual-btn");
            const fileUploadContainer = document.getElementById("file-upload-container");
            const manualInputContainer = document.getElementById("manual-input-container");
            const dcFileInput = document.getElementById("dc-file-input");
            const durationsFileInput = document.getElementById("durations-file-input");
            // START: NEW File Upload Buttons
            const dcFileUploadButton = document.getElementById("dc-file-upload-button");
            const durationsFileUploadButton = document.getElementById("durations-file-upload-button");
            // END: NEW File Upload Buttons
            const manualStep1 = document.getElementById("manual-step-1");
            const dcNameInput = document.getElementById("dc-name");
            const dcLocInput = document.getElementById("dc-loc");
            const dcLatInput = document.getElementById("dc-lat");
            const dcLonInput = document.getElementById("dc-lon");
            const dcFpalletInput = document.getElementById("dc-fpallet");
            const dcFpalletcapInput = document.getElementById("dc-fpalletcap");
            const dcNfpalletInput = document.getElementById("dc-nfpallet");
            const dcNfpalletcapInput = document.getElementById("dc-nfpalletcap");
            const manualNextBtn = document.getElementById("manual-next-btn");
            const manualStep2 = document.getElementById("manual-step-2");
            const originDcName = document.getElementById("origin-dc-name");
            const durationsListContainer = document.getElementById("durations-list-container");
            const addDurationBtn = document.getElementById("add-duration-btn");
            const manualBackBtn = document.getElementById("manual-back-btn");
            const manualUploadButton = document.getElementById("manual-upload-button");
            const statusAuth = document.getElementById("status-auth");
            const statusFile = document.getElementById("status-file");
            const statusDcs = document.getElementById("status-dcs");
            const statusDurations = document.getElementById("status-durations");
            const statusFinal = document.getElementById("status-final");
            const uploadAnotherButton = document.getElementById("upload-another-button");
            const dcListView = document.getElementById("dc-list-view");
            const dcListContainer = document.getElementById("dc-list-container");
            const dcListLoading = document.getElementById("dc-list-loading");
            const dcSearchInput = document.getElementById("dc-search-input");
            const durationListView = document.getElementById("duration-list-view");
            const backToDcsBtn = document.getElementById("back-to-dcs-btn");
            const durationViewTitle = document.getElementById("duration-view-title");
            const durationsList = document.getElementById("durations-list");
            const durationListLoading = document.getElementById("duration-list-loading");
            const addNewDurationBtn = document.getElementById("add-new-duration-btn");
            const editDcModal = document.getElementById("edit-dc-modal");
            const modalDcName = document.getElementById("modal-dc-name");
            const modalDcLoc = document.getElementById("modal-dc-loc");
            const modalDcLat = document.getElementById("modal-dc-lat");
            const modalDcLon = document.getElementById("modal-dc-lon");
            const modalDcFpallet = document.getElementById("modal-dc-fpallet");
            const modalDcFpalletcap = document.getElementById("modal-dc-fpalletcap");
            const modalDcNfpallet = document.getElementById("modal-dc-nfpallet");
            const modalDcNfpalletcap = document.getElementById("modal-dc-nfpalletcap");
            const modalDcCancel = document.getElementById("modal-dc-cancel");
            const modalDcSave = document.getElementById("modal-dc-save");
            const editDurationModal = document.getElementById("edit-duration-modal");
            const modalDurationTitle = document.getElementById("modal-duration-title");
            const modalDurationError = document.getElementById("modal-duration-error"); // NEW
            const modalDurationDest = document.getElementById("modal-duration-dest");
            const modalDurationKm = document.getElementById("modal-duration-km");
            const modalDurationText = document.getElementById("modal-duration-text");
            const modalDurationCancel = document.getElementById("modal-duration-cancel");
            const modalDurationSave = document.getElementById("modal-duration-save");
            const deleteConfirmModal = document.getElementById("delete-confirm-modal");
            const deleteConfirmText = document.getElementById("delete-confirm-text");
            const modalDeleteCancel = document.getElementById("modal-delete-cancel");
            const modalDeleteConfirm = document.getElementById("modal-delete-confirm");

            // NEW SELECTORS
            const avoidedListView = document.getElementById("avoided-list-view");
            const backToDcsFromAvoidedBtn = document.getElementById("back-to-dcs-from-avoided-btn");
            const avoidedViewTitle = document.getElementById("avoided-view-title");
            const avoidedList = document.getElementById("avoided-list");
            const avoidedListLoading = document.getElementById("avoided-list-loading");
            const addNewAvoidedBtn = document.getElementById("add-new-avoided-btn");
            const addAvoidedModal = document.getElementById("add-avoided-modal");
            const modalAvoidedTitle = document.getElementById("modal-avoided-title");
            const modalAvoidedError = document.getElementById("modal-avoided-error");
            const modalAvoidedTarget = document.getElementById("modal-avoided-target");
            const modalAvoidedReason = document.getElementById("modal-avoided-reason");
            const modalAvoidedCancel = document.getElementById("modal-avoided-cancel");
            const modalAvoidedSave = document.getElementById("modal-avoided-save");
            const forgotPasswordBtn = document.getElementById("forgot-password-btn");

            (async () => {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    await setPersistence(auth, inMemoryPersistence);

                    updateStatus(statusAuth, "pending", "Connecting...");

                    listenForDcUpdates();

                    const loginView = document.getElementById("login-view");
                    const mainContentView = document.getElementById("main-content-view");
                    const loginEmail = document.getElementById("login-email");
                    const loginPassword = document.getElementById("login-password");
                    const loginButton = document.getElementById("login-button");
                    const loginError = document.getElementById("login-error");
                    const logoutButton = document.getElementById("logout-button");
                    const backToHomeBtn = document.getElementById("back-to-home-btn");

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            // User is logged in
                            loginView.classList.add("hidden");
                            mainContentView.classList.remove("hidden");
                            logoutButton.classList.remove("hidden");
                            updateStatus(statusAuth, "success", `Logged in as ${user.email}`);
                        } else {
                            // User is logged out
                            loginView.classList.remove("hidden");
                            mainContentView.classList.add("hidden");
                            logoutButton.classList.add("hidden");
                            updateStatus(statusAuth, "pending", "Waiting for login...");
                        }
                    });

                    loginButton.addEventListener("click", async () => {
                        let email = loginEmail.value;
                        const password = loginPassword.value;

                        if (email && !email.includes("@")) {
                            email = email.trim().toLowerCase() + "@dc-searcher.com";
                        }

                        loginError.classList.add("hidden");
                        loginButton.disabled = true;
                        loginButton.textContent = "Logging in...";

                        try {
                            await signInWithEmailAndPassword(auth, email, password);
                            loginEmail.value = "";
                            loginPassword.value = "";
                        } catch (error) {
                            console.error("Login failed:", error.code);
                            if (
                                error.code === "auth/invalid-credential" ||
                                error.code === "auth/wrong-password" ||
                                error.code === "auth/user-not-found"
                            ) {
                                loginError.textContent = "Invalid email or password.";
                            } else {
                                loginError.textContent = "An error occurred. Please try again.";
                            }
                            loginError.classList.remove("hidden");
                        }
                        loginButton.disabled = false;
                        loginButton.textContent = "Login";
                    });

                    loginPassword.addEventListener("keypress", (e) => {
                        if (e.key === "Enter") {
                            loginButton.click();
                        }
                    });
                    loginEmail.addEventListener("keypress", (e) => {
                        if (e.key === "Enter") {
                            loginButton.click();
                        }
                    });

                    logoutButton.addEventListener("click", async () => {
                        await signOut(auth);
                    });

                    backToHomeBtn.addEventListener("click", async () => {
                        await signOut(auth);
                        window.location.href = "../index.html";
                    });

                    forgotPasswordBtn.addEventListener("click", async () => {
                        const email = document.getElementById("login-email").value;
                        if (!email) {
                            document.getElementById("login-error").textContent =
                                'Please enter your email first, then click "Forgot Password".';
                            document.getElementById("login-error").classList.remove("hidden");
                            return;
                        }

                        document.getElementById("login-error").textContent = "Contact admin for reset password!";
                        document.getElementById("login-error").classList.remove("hidden");
                    });
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    updateStatus(statusAuth, "error", "Connection failed! Check your config keys.");
                    // START: UPDATED Disabled buttons
                    dcFileUploadButton.disabled = true;
                    durationsFileUploadButton.disabled = true;
                    // END: UPDATED Disabled buttons
                    manualNextBtn.disabled = true;
                    manualUploadButton.disabled = true;
                }
            })();

            function updateStatus(element, status, message) {
                const dot = element.querySelector(".status-dot");
                dot.className = `status-dot ${status}`;
                element.childNodes[2].textContent = ` ${message}`;
            }

            // START: UPDATED resetUploader
            function resetUploader() {
                dcFileUploadButton.disabled = false;
                dcFileUploadButton.textContent = "Upload DC File";
                durationsFileUploadButton.disabled = false;
                durationsFileUploadButton.textContent = "Upload Durations File";

                manualUploadButton.disabled = false;
                manualUploadButton.textContent = "Upload Manual Data";
                uploadAnotherButton.classList.add("hidden");

                dcFileInput.value = null;
                durationsFileInput.value = null;

                dcNameInput.value = "";
                dcLocInput.value = "";
                dcLatInput.value = "";
                dcLonInput.value = "";
                dcFpalletInput.value = "";
                dcFpalletcapInput.value = "";
                dcNfpalletInput.value = "";
                dcNfpalletcapInput.value = "";

                durationsListContainer.innerHTML = "";
                manualStep1.classList.remove("hidden");
                manualStep2.classList.add("hidden");

                toggleFileBtn.classList.add("active");
                toggleFileBtn.classList.remove("inactive");
                toggleManualBtn.classList.add("inactive");
                toggleManualBtn.classList.remove("active");
                fileUploadContainer.classList.remove("hidden");
                manualInputContainer.classList.add("hidden");

                updateStatus(statusFile, "", "Pending");
                updateStatus(statusDcs, "", "Pending");
                updateStatus(statusDurations, "", "Pending");
                statusFinal.textContent = "";
                viewUploaderBtn.click();
            }
            // END: UPDATED resetUploader

            /**
             * Utility to split a CSV line, handling quoted fields.
             * This is designed *specifically* for your format.
             */
            function splitCsvLine(line) {
                const fields = [];
                let inQuote = false;
                let field = "";

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        // Toggle quote mode. We skip adding the quote itself.
                        inQuote = !inQuote;
                        continue;
                    }

                    if (char === "," && !inQuote) {
                        // We are at a delimiter and not in a quote
                        fields.push(field.trim());
                        field = "";
                    } else {
                        // Add the character to the current field
                        field += char;
                    }
                }

                fields.push(field.trim());
                return fields;
            }

            /**
             * Parses the DC CSV content.
             * Expected format: loc,name,"lat,lon",fpallet,fpalletcap,nfpallet,nfpalletcap
             */
            function parseDcCsv(csvContent) {
                const dcsData = [];
                const lines = csvContent
                    .replace(/\r/g, "")
                    .split("\n")
                    .filter((line) => line.trim() !== "");

                if (lines.length <= 1) {
                    throw new Error("DC file is empty or missing headers.");
                }

                // Start from 1 to skip header
                for (let i = 1; i < lines.length; i++) {
                    const parts = splitCsvLine(lines[i]);
                    if (parts.length < 7) {
                        console.warn(`Skipping malformed DC line (expected 7 columns): ${lines[i]}`);
                        continue;
                    }

                    const loc = parts[0];
                    const name = parts[1];
                    const llSource = parts[2]; // This will be "lat,lon"
                    const fpallet = parseFloat(parts[3]) || 0;
                    const fpalletcap = parseFloat(parts[4]) || 0;
                    const nfpallet = parseFloat(parts[5]) || 0;
                    const nfpalletcap = parseFloat(parts[6]) || 0;

                    if (!loc || !name || !llSource) {
                        console.warn(`Skipping DC line with empty fields: ${lines[i]}`);
                        continue;
                    }

                    const [latStr, lonStr] = llSource.split(",");
                    const lat = parseFloat(latStr);
                    const lon = parseFloat(lonStr);

                    if (isNaN(lat) || isNaN(lon)) {
                        console.warn(`Skipping DC line with invalid coordinates: ${lines[i]}`);
                        continue;
                    }

                    dcsData.push({
                        name,
                        loc,
                        lat,
                        lon,
                        fpallet,
                        fpalletcap,
                        nfpallet,
                        nfpalletcap,
                        id: null
                    });
                }
                return dcsData;
            }

            /**
             * Parses the Durations CSV content.
             * Expected format: loc source,"lat,lon",Loc Dest,loc dest,"lat,lon",KM,Duration
             */
            function parseDurationsCsv(csvContent) {
                const durationsData = {};
                const lines = csvContent
                    .replace(/\r/g, "")
                    .split("\n")
                    .filter((line) => line.trim() !== "");

                if (lines.length <= 1) {
                    throw new Error("Durations file is empty or missing headers.");
                }

                // Start from 1 to skip header
                for (let i = 1; i < lines.length; i++) {
                    const parts = splitCsvLine(lines[i]);
                    if (parts.length < 7) {
                        // Now expect 7 fields
                        console.warn(`Skipping malformed duration line: ${lines[i]}`);
                        continue;
                    }

                    const origin = parts[0];
                    const dest = parts[3];
                    const kmRaw = parts[5];
                    const duration = parts[6];

                    if (!origin || !dest || !kmRaw || !duration) {
                        console.warn(`Skipping duration line with empty fields: ${lines[i]}`);
                        continue;
                    }

                    if (!durationsData[origin]) {
                        durationsData[origin] = {};
                    }

                    const km = kmRaw && !kmRaw.toUpperCase().endsWith(" KM") ? `${kmRaw} KM` : kmRaw;

                    durationsData[origin][dest] = { km, duration };
                }
                return durationsData;
            }

            function readFileContent(file) {
                return new Promise((resolve, reject) => {
                    if (!file) {
                        reject(new Error("No file selected."));
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (event) => resolve(event.target.result);
                    reader.onerror = (error) => reject(error);
                    reader.readAsText(file);
                });
            }

            function parseDurationToSeconds(durationString) {
                if (!durationString || typeof durationString !== "string") return null;
                let totalSeconds = 0;
                const hoursMatch = durationString.match(/(\d+)\s*(h|hour|hours|j|jam)/i);
                const minutesMatch = durationString.match(/(\d+)\s*(m|min|mins|minutes|menit)/i);

                if (!hoursMatch && !minutesMatch) {
                    // Try to parse days
                    const dayMatch = durationString.match(/(\d+)\s*(d|day|days|h|hari)/i);
                    if (dayMatch) {
                        totalSeconds += parseInt(dayMatch[1], 10) * 24 * 3600;
                        return totalSeconds;
                    }
                    // Try to parse plain number as minutes
                    const secondsOnly = parseInt(durationString, 10);
                    if (!isNaN(secondsOnly) && String(secondsOnly) === durationString.trim()) {
                        console.warn(`Interpreting plain number "${durationString}" as minutes.`);
                        return secondsOnly * 60; // Assume plain number is minutes
                    }
                    if (totalSeconds === 0) return 0; // Handle "0"
                    return null; // Invalid format
                }

                if (hoursMatch && hoursMatch[1]) {
                    totalSeconds += parseInt(hoursMatch[1], 10) * 3600;
                }
                if (minutesMatch && minutesMatch[1]) {
                    totalSeconds += parseInt(minutesMatch[1], 10) * 60;
                }

                // Handle day match in combination
                const dayMatch = durationString.match(/(\d+)\s*(d|day|days|h|hari)/i);
                if (dayMatch && dayMatch[1]) {
                    totalSeconds += parseInt(dayMatch[1], 10) * 24 * 3600;
                }

                return totalSeconds;
            }

            // --- Main View Toggle Logic ---
            viewUploaderBtn.addEventListener("click", () => {
                viewUploaderBtn.classList.add("active");
                viewEditorBtn.classList.remove("active");
                uploaderView.classList.remove("hidden");
                editorView.classList.add("hidden");
            });

            viewEditorBtn.addEventListener("click", () => {
                viewUploaderBtn.classList.remove("active");
                viewEditorBtn.classList.add("active");
                uploaderView.classList.add("hidden");
                editorView.classList.remove("hidden");
                showDcListView();
            });

            // --- Uploader View Logic (File/Manual) ---
            toggleFileBtn.addEventListener("click", () => {
                toggleFileBtn.classList.add("active");
                toggleFileBtn.classList.remove("inactive");
                toggleManualBtn.classList.add("inactive");
                toggleManualBtn.classList.remove("active");
                fileUploadContainer.classList.remove("hidden");
                manualInputContainer.classList.add("hidden");
            });

            toggleManualBtn.addEventListener("click", () => {
                toggleFileBtn.classList.add("inactive");
                toggleFileBtn.classList.remove("active");
                toggleManualBtn.classList.add("active");
                toggleManualBtn.classList.remove("inactive");
                fileUploadContainer.classList.add("hidden");
                manualInputContainer.classList.remove("hidden");
            });

            // --- Manual Input Form Logic ---
            manualNextBtn.addEventListener("click", () => {
                if (!dcNameInput.value || !dcLocInput.value || !dcLatInput.value || !dcLonInput.value) {
                    statusFinal.textContent = "Please fill in all DC details.";
                    statusFinal.style.color = "#EF4444";
                    return;
                }
                statusFinal.textContent = "";
                originDcName.textContent = dcNameInput.value;
                manualStep1.classList.add("hidden");
                manualStep2.classList.remove("hidden");
                // Don't auto-add a duration row, make it optional
                // if (durationsListContainer.children.length === 0) {
                //     addDurationRow();
                // }
            });

            manualBackBtn.addEventListener("click", () => {
                manualStep1.classList.remove("hidden");
                manualStep2.classList.add("hidden");
            });

            function addDurationRow() {
                const div = document.createElement("div");
                div.className = "duration-entry flex items-center space-x-2 p-2 bg-gray-50 rounded-lg";
                div.innerHTML = `
                <input type="text" placeholder="Destination DC" class="form-input dest-name w-1/3">
                <input type="text" placeholder="KM" class="form-input dest-km w-1/4"> <input type="text" placeholder="Duration (e.g., 2h 15m)" class="form-input dest-duration-text w-1/3">
                <button type="button" class="remove-duration-btn text-red-500 hover:text-red-700 font-bold p-2 w-auto" title="Remove row">X</button>
            `;
                div.querySelector(".remove-duration-btn").addEventListener("click", () => {
                    div.remove();
                });
                durationsListContainer.appendChild(div);
            }

            addDurationBtn.addEventListener("click", addDurationRow);

            // START: REFACTORED UPLOAD LOGIC
            /**
             * Processes and uploads only the DC data.
             */
            async function processDcsUpload(dcsData) {
                updateStatus(statusDcs, "pending", "Checking existing data in database...");
                try {
                    const dcsCollectionRef = collection(db, "dcs");
                    const dcsSnapshot = await getDocs(dcsCollectionRef);
                    let lastId = 0;
                    const existingDcNames = new Set();
                    dcsSnapshot.forEach((doc) => {
                        const data = doc.data();
                        existingDcNames.add(data.name);
                        const docId = Number(data.id);
                        if (!isNaN(docId) && docId > lastId) {
                            lastId = docId;
                        }
                    });
                    updateStatus(statusDcs, "pending", `Last ID is ${lastId}. Processing new data...`);

                    const processedDcsData = [];
                    let newIdCounter = lastId;
                    dcsData.forEach((dcFromFile) => {
                        if (typeof dcFromFile.name !== "string" || dcFromFile.name.trim() === "") {
                            console.warn("Skipping DC with invalid or missing name:", dcFromFile);
                            return;
                        }
                        if (existingDcNames.has(dcFromFile.name)) {
                            let existingDoc = dcsSnapshot.docs.find((d) => d.data().name === dcFromFile.name);
                            let existingId = existingDoc ? existingDoc.data().id : null;
                            processedDcsData.push({ ...dcFromFile, id: dcFromFile.id || existingId || 0 });
                        } else {
                            newIdCounter++;
                            processedDcsData.push({ ...dcFromFile, id: dcFromFile.id || newIdCounter });
                        }
                    });

                    updateStatus(statusDcs, "pending", "Uploading new/updated DC documents...");
                    const dcsBatch = writeBatch(db);
                    processedDcsData.forEach((dc) => {
                        const docRef = doc(db, "dcs", dc.name);
                        dc.lat = Number(dc.lat) || 0;
                        dc.lon = Number(dc.lon) || 0;
                        dc.fpallet = Number(dc.fpallet) || 0;
                        dc.fpalletcap = Number(dc.fpalletcap) || 0;
                        dc.nfpallet = Number(dc.nfpallet) || 0;
                        dc.nfpalletcap = Number(dc.nfpalletcap) || 0;
                        dcsBatch.set(docRef, dc, { merge: true });
                    });
                    await dcsBatch.commit();
                    updateStatus(statusDcs, "success", `Uploaded/updated ${processedDcsData.length} documents.`);
                    statusFinal.textContent = " DC Upload Complete! ";
                    statusFinal.style.color = "#10B981";
                } catch (error) {
                    console.error("DC Upload failed:", error);
                    updateStatus(statusDcs, "error", "Upload failed. Check console.");
                    statusFinal.textContent = "DC Upload Failed. See console for details.";
                    statusFinal.style.color = "#EF4444";
                    throw error; // Re-throw to be caught by handler
                }
            }

            /**
             * Processes and uploads only the Durations data.
             */
            async function processDurationsUpload(durationsData) {
                updateStatus(statusDurations, "pending", "Uploading new/updated Durations documents...");
                try {
                    const durationsBatch = writeBatch(db);
                    Object.keys(durationsData).forEach((originName) => {
                        if (typeof originName !== "string" || originName.trim() === "") {
                            console.warn("Skipping duration with invalid origin name:", originName);
                            return;
                        }
                        const docRef = doc(db, "durations", originName);
                        const docData = {
                            durations: durationsData[originName]
                        };
                        durationsBatch.set(docRef, docData, { merge: true }); // Use merge to avoid overwriting
                    });
                    await durationsBatch.commit();
                    updateStatus(
                        statusDurations,
                        "success",
                        `Uploaded/updated ${Object.keys(durationsData).length} documents.`
                    );
                    statusFinal.textContent = " Durations Upload Complete! ";
                    statusFinal.style.color = "#10B981";
                } catch (error) {
                    console.error("Durations Upload failed:", error);
                    updateStatus(statusDurations, "error", "Upload failed. Check console.");
                    statusFinal.textContent = "Durations Upload Failed. See console for details.";
                    statusFinal.style.color = "#EF4444";
                    throw error; // Re-throw to be caught by handler
                }
            }

            /**
             * Handles the DC File Upload button click.
             */
            dcFileUploadButton.addEventListener("click", async () => {
                statusFinal.textContent = "";
                updateStatus(statusDcs, "pending", "Pending...");
                updateStatus(statusDurations, "pending", "Pending...");
                const dcFile = dcFileInput.files[0];

                if (!dcFile) {
                    statusFinal.textContent = "Please select a DC file.";
                    statusFinal.style.color = "#EF4444";
                    return;
                }

                dcFileUploadButton.disabled = true;
                dcFileUploadButton.textContent = "Reading...";

                try {
                    updateStatus(statusFile, "pending", "Reading DC file...");
                    const dcFileContent = await readFileContent(dcFile);
                    const dcsData = parseDcCsv(dcFileContent);
                    updateStatus(statusFile, "success", `Read ${dcsData.length} DC entries. Uploading...`);

                    await processDcsUpload(dcsData);
                    dcFileUploadButton.textContent = "Done!";
                } catch (error) {
                    console.error("Error reading or parsing DC file:", error);
                    const errorMessage = `Error: ${error.message}. Check console.`;
                    updateStatus(statusFile, "error", errorMessage);
                    statusFinal.textContent = "Upload Failed. Fix file content.";
                    statusFinal.style.color = "#EF4444";
                    dcFileUploadButton.textContent = "Failed";
                } finally {
                    uploadAnotherButton.classList.remove("hidden");
                }
            });

            /**
             * Handles the Durations File Upload button click.
             */
            durationsFileUploadButton.addEventListener("click", async () => {
                statusFinal.textContent = "";
                updateStatus(statusDcs, "pending", "Pending...");
                updateStatus(statusDurations, "pending", "Pending...");
                const durationsFile = durationsFileInput.files[0];

                if (!durationsFile) {
                    statusFinal.textContent = "Please select a Durations file.";
                    statusFinal.style.color = "#EF4444";
                    return;
                }

                durationsFileUploadButton.disabled = true;
                durationsFileUploadButton.textContent = "Reading...";

                try {
                    updateStatus(statusFile, "pending", "Reading Durations file...");
                    const durationsFileContent = await readFileContent(durationsFile);
                    const durationsData = parseDurationsCsv(durationsFileContent);
                    const durationCount = Object.keys(durationsData).length;
                    updateStatus(statusFile, "success", `Read ${durationCount} DC origins. Uploading...`);

                    await processDurationsUpload(durationsData);
                    durationsFileUploadButton.textContent = "Done!";
                } catch (error) {
                    console.error("Error reading or parsing Durations file:", error);
                    const errorMessage = `Error: ${error.message}. Check console.`;
                    updateStatus(statusFile, "error", errorMessage);
                    statusFinal.textContent = "Upload Failed. Fix file content.";
                    statusFinal.style.color = "#EF4444";
                    durationsFileUploadButton.textContent = "Failed";
                } finally {
                    uploadAnotherButton.classList.remove("hidden");
                }
            });

            /**
             * Handles the Manual Upload button click.
             */
            manualUploadButton.addEventListener("click", async () => {
                statusFinal.textContent = "";
                const dcsData = [
                    {
                        name: dcNameInput.value,
                        loc: dcLocInput.value,
                        lat: Number(dcLatInput.value),
                        lon: Number(dcLonInput.value),
                        fpallet: Number(dcFpalletInput.value) || 0,
                        fpalletcap: Number(dcFpalletcapInput.value) || 0,
                        nfpallet: Number(dcNfpalletInput.value) || 0,
                        nfpalletcap: Number(dcNfpalletcapInput.value) || 0
                    }
                ];

                const originDCName = dcNameInput.value;
                const innerDurations = {};
                let durationsData = {}; // Initialize as empty
                const durationEntries = durationsListContainer.querySelectorAll(".duration-entry");
                let isValid = true;
                let allEntriesEmpty = true;
                let firstErrorMessage = "";

                durationEntries.forEach((entry) => {
                    const destName = entry.querySelector(".dest-name").value;
                    const destKmRaw = entry.querySelector(".dest-km").value;
                    const destDurationText = entry.querySelector(".dest-duration-text").value;

                    if (destName || destKmRaw || destDurationText) {
                        allEntriesEmpty = false;
                        if (!destName || !destKmRaw || !destDurationText) {
                            isValid = false;
                            if (!firstErrorMessage)
                                firstErrorMessage = "Please fill all 3 fields for all duration entries.";
                        } else {
                            const seconds = parseDurationToSeconds(destDurationText);
                            if (seconds === null) {
                                isValid = false;
                                if (!firstErrorMessage)
                                    firstErrorMessage = `Invalid duration format: "${destDurationText}". Use "2h 15m" or "90m".`;
                            } else {
                                const destKm =
                                    destKmRaw && !destKmRaw.toUpperCase().endsWith(" KM")
                                        ? `${destKmRaw} KM`
                                        : destKmRaw;
                                innerDurations[destName] = {
                                    km: destKm,
                                    duration: destDurationText
                                };
                            }
                        }
                    }
                });

                if (!allEntriesEmpty) {
                    if (!isValid) {
                        statusFinal.textContent = firstErrorMessage;
                        statusFinal.style.color = "#EF4444";
                        return;
                    }
                    durationsData[originDCName] = innerDurations;
                }
                // If allEntriesEmpty is true, durationsData remains {}

                updateStatus(statusFile, "success", "Manual data formatted successfully.");
                manualUploadButton.disabled = true;
                manualUploadButton.textContent = "Uploading...";

                try {
                    // Always upload the DC data
                    await processDcsUpload(dcsData);

                    // Conditionally upload durations only if they were added
                    if (Object.keys(durationsData).length > 0) {
                        await processDurationsUpload(durationsData);
                    } else {
                        updateStatus(statusDurations, "pending", "No durations added, skipping.");
                    }

                    statusFinal.textContent = " Manual Upload Complete! ";
                    manualUploadButton.textContent = "Done!";
                } catch (error) {
                    statusFinal.textContent = "Manual Upload Failed. See console.";
                    manualUploadButton.textContent = "Failed";
                } finally {
                    uploadAnotherButton.classList.remove("hidden");
                }
            });
            // END: REFACTORED UPLOAD LOGIC

            // "Upload Another" Button
            uploadAnotherButton.addEventListener("click", resetUploader);

            // --- Editor & Modal Logic (Unchanged) ---
            function listenForDcUpdates() {
                const dcsCollectionRef = collection(db, "dcs");
                onSnapshot(
                    dcsCollectionRef,
                    (snapshot) => {
                        allDcs = [];
                        snapshot.forEach((doc) => {
                            allDcs.push(doc.data());
                        });
                        allDcs.sort((a, b) => a.name.localeCompare(b.name));
                        renderDcList();
                    },
                    (error) => {
                        console.error("Error listening for DC updates:", error);
                        dcListContainer.innerHTML = `<p class="text-red-500">Error loading DC list. Check console.</p>`;
                    }
                );
            }

            function renderDcList() {
                dcListContainer.innerHTML = "";
                const searchTerm = dcSearchInput.value.toLowerCase();
                const filteredDcs = allDcs.filter(
                    (dc) =>
                        dc.name.toLowerCase().includes(searchTerm) ||
                        (dc.loc && dc.loc.toLowerCase().includes(searchTerm))
                );
                if (filteredDcs.length === 0) {
                    if (allDcs.length > 0) {
                        dcListContainer.innerHTML = `<p class="text-gray-500">No DCs match your search.</p>`;
                    } else {
                        dcListContainer.innerHTML = `<p class="text-gray-500">No DCs found in the database.</p>`;
                    }
                    return;
                }
                filteredDcs.forEach((dc) => {
                    const item = document.createElement("div");
                    item.className = "dc-list-item";
                    item.innerHTML = `
                    <div>
                        <h4 class="font-semibold text-lg text-blue-700">${dc.name}</h4>
                        <p class="text-sm text-gray-600">Loc: ${dc.loc}</p>
                        <p class="text-xs text-gray-500">Lat: ${dc.lat}, Lon: ${dc.lon}</p>
                        <p class="text-xs text-gray-500">Food: ${dc.fpallet || 0}/${dc.fpalletcap || 0} | Non-Food: ${dc.nfpallet || 0
                        }/${dc.nfpalletcap || 0}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button data-dcname="${dc.name}" class="manage-avoided-btn bg-orange-100 text-orange-700 font-medium py-2 px-3 rounded-lg text-sm hover:bg-orange-200">Avoids</button>
                        <button data-dcname="${dc.name}" class="manage-durations-btn bg-blue-600 text-white font-medium py-2 px-3 rounded-lg text-sm hover:bg-blue-700">Manage</button>
                        <button data-dcname="${dc.name}" class="edit-dc-btn bg-gray-200 text-gray-800 font-medium py-2 px-3 rounded-lg text-sm hover:bg-gray-300">Edit</button>
                        <button data-dcname="${dc.name}" class="delete-dc-btn bg-red-100 text-red-700 font-medium py-2 px-3 rounded-lg text-sm hover:bg-red-200">Delete</button>
                    </div>
                `;
                    dcListContainer.appendChild(item);
                });
                dcListContainer.querySelectorAll(".manage-avoided-btn").forEach((btn) => {
                    btn.addEventListener("click", () => showAvoidedView(btn.dataset.dcname));
                });
                dcListContainer.querySelectorAll(".manage-durations-btn").forEach((btn) => {
                    btn.addEventListener("click", () => showDurationsView(btn.dataset.dcname));
                });
                dcListContainer.querySelectorAll(".edit-dc-btn").forEach((btn) => {
                    btn.addEventListener("click", () => openDcEditModal(btn.dataset.dcname));
                });
                dcListContainer.querySelectorAll(".delete-dc-btn").forEach((btn) => {
                    btn.addEventListener("click", () => openDeleteModal("dc", btn.dataset.dcname));
                });
            }

            async function loadAndRenderDurations(dcName) {
                durationsList.innerHTML = "";
                durationListLoading.classList.remove("hidden");
                const docRef = doc(db, "durations", dcName);
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        currentDurations = data.durations || {};
                        const destinations = Object.keys(currentDurations);
                        if (destinations.length === 0) {
                            durationsList.innerHTML = `<p class="text-gray-500">No durations found for ${dcName}.</p>`;
                        } else {
                            destinations.sort().forEach((destName) => {
                                const durationData = currentDurations[destName];
                                const item = document.createElement("div");
                                item.className = "duration-list-item";
                                item.innerHTML = `
                                <div>
                                    <h4 class="font-semibold text-lg">${destName}</h4>
                                    <p class="text-sm text-gray-600">KM: ${durationData.km} | Duration: ${durationData.duration}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button data-destname="${destName}" class="edit-duration-btn bg-gray-200 text-gray-800 font-medium py-2 px-3 rounded-lg text-sm hover:bg-gray-300">Edit</button>
                                    <button data-destname="${destName}" class="delete-duration-btn bg-red-100 text-red-700 font-medium py-2 px-3 rounded-lg text-sm hover:bg-red-200">Delete</button>
                                </div>
                            `;
                                durationsList.appendChild(item);
                            });
                            durationsList.querySelectorAll(".edit-duration-btn").forEach((btn) => {
                                btn.addEventListener("click", () => openDurationModal("edit", btn.dataset.destname));
                            });
                            durationsList.querySelectorAll(".delete-duration-btn").forEach((btn) => {
                                btn.addEventListener("click", () =>
                                    openDeleteModal("duration", currentEditingDcName, btn.dataset.destname)
                                );
                            });
                        }
                    } else {
                        currentDurations = {};
                        durationsList.innerHTML = `<p class="text-gray-500">No durations document found for ${dcName}.</p>`;
                    }
                } catch (error) {
                    console.error("Error fetching durations:", error);
                    durationsList.innerHTML = `<p class="text-red-500">Error loading durations. Check console.</p>`;
                } finally {
                    durationListLoading.classList.add("hidden");
                }
            }

            // --- AVOIDED LOGIC ---
            async function loadAndRenderAvoided(dcName) {
                avoidedList.innerHTML = "";
                avoidedListLoading.classList.remove("hidden");
                const docRef = doc(db, "avoided_destinations", dcName);

                try {
                    const docSnap = await getDoc(docRef);
                    currentAvoided = [];
                    if (docSnap.exists()) {
                        // Data structure: { avoid_list: [ { target: "DC B", reason: "Reason" }, ... ] }
                        currentAvoided = docSnap.data().avoid_list || [];
                    }

                    if (currentAvoided.length === 0) {
                        avoidedList.innerHTML = `<p class="text-gray-500">No avoided destinations for ${dcName}.</p>`;
                    } else {
                        currentAvoided.forEach(item => {
                            const div = document.createElement("div");
                            div.className = "flex justify-between items-center p-3 bg-red-50 rounded-lg border border-red-100";
                            div.innerHTML = `
                                <div>
                                    <h4 class="font-bold text-red-800">${item.target}</h4>
                                    <p class="text-sm text-red-600">Reason: ${item.reason}</p>
                                </div>
                                <button class="delete-avoided-btn bg-white text-red-600 border border-red-200 font-medium py-1 px-3 rounded hover:bg-red-50" data-target="${item.target}">Remove</button>
                            `;
                            avoidedList.appendChild(div);
                        });

                        avoidedList.querySelectorAll(".delete-avoided-btn").forEach(btn => {
                            btn.addEventListener("click", () => openDeleteModal("avoided", dcName, btn.dataset.target));
                        });
                    }
                } catch (error) {
                    console.error("Error fetching avoided list:", error);
                    avoidedList.innerHTML = `<p class="text-red-500">Error loading data. Check console.</p>`;
                } finally {
                    avoidedListLoading.classList.add("hidden");
                }
            }

            function showDcListView() {
                dcListView.classList.remove("hidden");
                durationListView.classList.add("hidden");
                avoidedListView.classList.add("hidden"); // NEW
                currentEditingDcName = null;
                currentDurations = {};
            }
            // NEW
            function showAvoidedView(dcName) {
                dcListView.classList.add("hidden");
                durationListView.classList.add("hidden");
                avoidedListView.classList.remove("hidden");
                avoidedViewTitle.textContent = `Manage Avoided Destinations for ${dcName}`;
                currentEditingDcName = dcName;
                // Fetch durations too, so we can filter the add list
                const durRef = doc(db, "durations", dcName);
                getDoc(durRef).then(snap => {
                    if (snap.exists()) {
                        currentDurations = snap.data().durations || {};
                    } else {
                        currentDurations = {};
                    }
                });
                loadAndRenderAvoided(dcName);
            }

            backToDcsFromAvoidedBtn.addEventListener("click", showDcListView);
            addNewAvoidedBtn.addEventListener("click", () => {
                modalAvoidedError.classList.add("hidden");
                modalAvoidedTarget.innerHTML = '<option value="">-- Select DC to Avoid --</option>';
                // Populate select with other DCs not already avoided
                const existingTargets = currentAvoided.map(x => x.target);

                // Filter: Must be in currentDurations AND not already avoided
                const availableDestinations = Object.keys(currentDurations);

                allDcs.forEach(dc => {
                    if (dc.name !== currentEditingDcName
                        && !existingTargets.includes(dc.name)
                        && availableDestinations.includes(dc.name)) { // NEW CONDITION
                        modalAvoidedTarget.innerHTML += `<option value="${dc.name}">${dc.name}</option>`;
                    }
                });

                modalAvoidedReason.value = "";
                addAvoidedModal.classList.remove("hidden");
            });

            modalAvoidedCancel.addEventListener("click", () => {
                addAvoidedModal.classList.add("hidden");
            });

            modalAvoidedSave.addEventListener("click", async () => {
                const targetName = modalAvoidedTarget.value;
                const reason = modalAvoidedReason.value.trim();

                if (!targetName) {
                    modalAvoidedError.textContent = "Please select a target DC.";
                    modalAvoidedError.classList.remove("hidden");
                    return;
                }
                if (!reason) {
                    modalAvoidedError.textContent = "Please enter a reason.";
                    modalAvoidedError.classList.remove("hidden");
                    return;
                }

                modalAvoidedSave.textContent = "Saving...";
                modalAvoidedSave.disabled = true;

                try {
                    const batch = writeBatch(db);

                    // 1. Add target to current DC's list
                    const currentRef = doc(db, "avoided_destinations", currentEditingDcName);
                    // We need to read it freshly to be safe, or just use arrayUnion which is safer for concurrency
                    // BUT arrayUnion treats objects as unique only if all fields match. 
                    // Let's read-modify-write for safety and consistent structure handling or utilize getDoc we did earlier?
                    // Actually, arrayUnion is fine if we construct the object correctly.

                    // However, we want to SUPPORT EDITING? No requirements for editing reason yet, just add/delete.
                    // Let's use arrayUnion.
                    const newItemForCurrent = { target: targetName, reason: reason };
                    // We can use set with merge for the doc creation if it doesn't exist
                    batch.set(currentRef, {
                        avoid_list: arrayUnion(newItemForCurrent)
                    }, { merge: true });

                    // 2. Add current DC to target's list (Bidirectional)
                    const targetRef = doc(db, "avoided_destinations", targetName);
                    const newItemForTarget = { target: currentEditingDcName, reason: reason };
                    batch.set(targetRef, {
                        avoid_list: arrayUnion(newItemForTarget)
                    }, { merge: true });

                    await batch.commit();

                    addAvoidedModal.classList.add("hidden");
                    loadAndRenderAvoided(currentEditingDcName);

                } catch (error) {
                    console.error("Error saving avoided:", error);
                    modalAvoidedError.textContent = "Failed to save. Check console.";
                    modalAvoidedError.classList.remove("hidden");
                } finally {
                    modalAvoidedSave.textContent = "Save";
                    modalAvoidedSave.disabled = false;
                }
            });
            function showDurationsView(dcName) {
                dcListView.classList.add("hidden");
                durationListView.classList.remove("hidden");
                durationViewTitle.textContent = `Manage Durations for ${dcName}`;
                currentEditingDcName = dcName;
                loadAndRenderDurations(dcName);
            }
            backToDcsBtn.addEventListener("click", showDcListView);
            dcSearchInput.addEventListener("input", renderDcList);

            function openDcEditModal(dcName) {
                const dc = allDcs.find((d) => d.name === dcName);
                if (!dc) return;
                modalDcName.value = dc.name;
                modalDcLoc.value = dc.loc;
                modalDcLat.value = dc.lat;
                modalDcLon.value = dc.lon;
                modalDcFpallet.value = dc.fpallet || 0;
                modalDcFpalletcap.value = dc.fpalletcap || 0;
                modalDcNfpallet.value = dc.nfpallet || 0;
                modalDcNfpalletcap.value = dc.nfpalletcap || 0;
                editDcModal.classList.remove("hidden");
            }
            modalDcCancel.addEventListener("click", () => {
                editDcModal.classList.add("hidden");
            });

            modalDcSave.addEventListener("click", async () => {
                const dcName = modalDcName.value;
                const docRef = doc(db, "dcs", dcName);
                try {
                    await updateDoc(docRef, {
                        loc: modalDcLoc.value,
                        lat: Number(modalDcLat.value),
                        lon: Number(modalDcLon.value),
                        fpallet: Number(modalDcFpallet.value) || 0,
                        fpalletcap: Number(modalDcFpalletcap.value) || 0,
                        nfpallet: Number(modalDcNfpallet.value) || 0,
                        nfpalletcap: Number(modalDcNfpalletcap.value) || 0
                    });
                    editDcModal.classList.add("hidden");
                } catch (error) {
                    console.error("Error updating DC:", error);
                    statusFinal.textContent = "Failed to update DC. Check console.";
                    statusFinal.style.color = "#EF4444";
                }
            });

            function openDurationModal(mode, destName = null) {
                modalDurationError.classList.add("hidden");

                modalDurationDest.innerHTML = '<option value="">-- Select a Destination --</option>';
                allDcs.forEach((dc) => {
                    if (dc.name !== currentEditingDcName) {
                        modalDurationDest.innerHTML += `<option value="${dc.name}">${dc.name}</option>`;
                    }
                });
                if (mode === "edit") {
                    const data = currentDurations[destName];
                    if (!data) return;
                    modalDurationTitle.textContent = `Edit Duration to ${destName}`;
                    modalDurationDest.value = destName;
                    modalDurationDest.readOnly = true;
                    modalDurationDest.classList.add("form-input[readonly]");
                    modalDurationKm.value = String(data.km).replace(" KM", "");
                    modalDurationText.value = data.duration;
                    modalDurationSave.dataset.mode = "edit";
                    modalDurationSave.dataset.origName = destName;
                } else {
                    modalDurationTitle.textContent = `Add New Duration from ${currentEditingDcName}`;
                    modalDurationDest.value = "";
                    modalDurationDest.readOnly = false;
                    modalDurationDest.classList.remove("form-input[readonly]");
                    modalDurationKm.value = "";
                    modalDurationText.value = "";
                    modalDurationSave.dataset.mode = "add";
                    modalDurationSave.dataset.origName = "";
                }
                editDurationModal.classList.remove("hidden");
            }
            modalDurationCancel.addEventListener("click", () => {
                editDurationModal.classList.add("hidden");
            });
            addNewDurationBtn.addEventListener("click", () => openDurationModal("add"));

            modalDurationSave.addEventListener("click", async () => {
                const mode = modalDurationSave.dataset.mode;
                const newDestName = modalDurationDest.value;
                const origName = modalDurationSave.dataset.origName;
                const kmRaw = modalDurationKm.value;

                let errorMsg = "";
                if (!newDestName || !kmRaw || !modalDurationText.value) {
                    errorMsg = "Please fill in all fields.";
                } else if (parseDurationToSeconds(modalDurationText.value) === null) {
                    errorMsg = `Invalid duration format: "${modalDurationText.value}". Use "2h 15m" or "90m".`;
                } else if (mode === "add" && currentDurations.hasOwnProperty(newDestName)) {
                    errorMsg = `A duration for "${newDestName}" already exists.`;
                }

                if (errorMsg) {
                    modalDurationError.textContent = errorMsg;
                    modalDurationError.classList.remove("hidden");
                    return;
                }

                if (mode === "edit" && origName !== newDestName) {
                    delete currentDurations[origName];
                }

                const kmValue = kmRaw && !String(kmRaw).toUpperCase().endsWith(" KM") ? `${kmRaw} KM` : kmRaw;

                currentDurations[newDestName] = {
                    km: kmValue,
                    duration: modalDurationText.value
                };

                const docRef = doc(db, "durations", currentEditingDcName);
                try {
                    await setDoc(docRef, { durations: currentDurations });
                    editDurationModal.classList.add("hidden");
                    loadAndRenderDurations(currentEditingDcName);
                } catch (error) {
                    console.error("Error saving duration:", error);
                    modalDurationError.textContent = "Failed to save. Check console.";
                    modalDurationError.classList.remove("hidden");
                }
            });

            function openDeleteModal(type, name1, name2 = null) {
                currentDeleteContext = { type, name1, name2 };
                if (type === "dc") {
                    deleteConfirmText.textContent = `Do you really want to delete "${name1}"? This will also delete its entire duration list. This action cannot be undone.`;
                } else if (type === "avoided") {
                    deleteConfirmText.textContent = `Do you really want to remove the avoidance rule between "${name1}" and "${name2}"? This will remove it from both DCs.`;
                } else {
                    deleteConfirmText.textContent = `Do you really want to delete the duration from "${name1}" to "${name2}"? This action cannot be undone.`;
                }
                deleteConfirmModal.classList.remove("hidden");
            }
            modalDeleteCancel.addEventListener("click", () => {
                deleteConfirmModal.classList.add("hidden");
                currentDeleteContext = {};
            });

            modalDeleteConfirm.addEventListener("click", async () => {
                const { type, name1, name2 } = currentDeleteContext;
                try {
                    if (type === "dc") {
                        await deleteDoc(doc(db, "dcs", name1));
                        await deleteDoc(doc(db, "durations", name1));
                    } else if (type === "duration") {
                        delete currentDurations[name2];
                        const docRef = doc(db, "durations", name1);
                        await setDoc(docRef, { durations: currentDurations });
                        loadAndRenderDurations(name1);
                    } else if (type === "avoided") {
                        // Bidirectional Delete
                        // We need to find the full objects to remove them using arrayRemove, BUT arrayRemove requires exact object match.
                        // So we first need to read both docs to find the objects with the matching reasons...
                        // OR we can just read-modify-write the arrays.

                        try {
                            const batch = writeBatch(db);

                            // 1. Remove from name1 (currentEditingDcName)
                            const ref1 = doc(db, "avoided_destinations", name1);
                            const snap1 = await getDoc(ref1);
                            if (snap1.exists()) {
                                const list1 = snap1.data().avoid_list || [];
                                const newList1 = list1.filter(item => item.target !== name2);
                                batch.update(ref1, { avoid_list: newList1 });
                            }

                            // 2. Remove from name2 (the target)
                            const ref2 = doc(db, "avoided_destinations", name2);
                            const snap2 = await getDoc(ref2);
                            if (snap2.exists()) {
                                const list2 = snap2.data().avoid_list || [];
                                const newList2 = list2.filter(item => item.target !== name1);
                                batch.update(ref2, { avoid_list: newList2 });
                            }

                            await batch.commit();
                            loadAndRenderAvoided(name1);

                        } catch (e) {
                            console.error("Bidirectional delete failed", e);
                            throw e;
                        }

                    }
                } catch (error) {
                    console.error("Error deleting item:", error);
                    statusFinal.textContent = "Failed to delete. Check console.";
                    statusFinal.style.color = "#EF4444";
                } finally {
                    deleteConfirmModal.classList.add("hidden");
                    currentDeleteContext = {};
                }
            });
        </script>
    </body>

</html>